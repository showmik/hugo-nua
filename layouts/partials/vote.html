<!-- Upvote widget (self-contained) -->
<div class="vote" data-slug="{{ .RelPermalink }}" role="group" aria-label="Upvote this article">
  <button class="vote-btn" type="button" data-action="upvote" aria-pressed="false" aria-label="Upvote" title="Upvote">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="24" height="24" stroke="currentColor" stroke-width="2"
         fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="17 11 12 6 7 11"></polyline>
      <polyline points="17 18 12 13 7 18"></polyline>
    </svg>
  </button>
  <span class="vote-count" data-count aria-live="polite" aria-atomic="true">0</span>
</div>

<script>
(() => {
  const el = document.currentScript.previousElementSibling;
  if (!el || !el.matches('.vote[data-slug]')) return;

  const slug = new URL(el.dataset.slug, document.baseURI).pathname.replace(/\/+$/, '/') || '/';
  const btn  = el.querySelector('button[data-action="upvote"]');
  const out  = el.querySelector('[data-count]');

  // ---------- safe storage helpers (no regex) ----------
  const STORAGE_OK = (() => { try { localStorage.setItem('_p','1'); localStorage.removeItem('_p'); return true; } catch { return false; } })();
  const LS = {
    get(k){ if (!STORAGE_OK) return null; try { return localStorage.getItem(k); } catch { return null; } },
    set(k,v){ if (!STORAGE_OK) return; try { localStorage.setItem(k,v); } catch {} }
  };

  // Cookie helpers without RegExp
  const cookieGet = (name) => {
    try {
      const arr = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < arr.length; i++) {
        const part = arr[i].trim();
        if (part.startsWith(name + '=')) return decodeURIComponent(part.slice(name.length + 1));
      }
    } catch {}
    return null;
  };
  const cookieSet = (name, val, days = 730) => {
    try {
      const d = new Date(); d.setTime(d.getTime() + days*864e5);
      document.cookie = `${name}=${encodeURIComponent(val)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
    } catch {}
  };

  const uuid = () => (self.crypto && crypto.randomUUID)
    ? crypto.randomUUID()
    : `${Date.now()}-${Math.random().toString(16).slice(2)}`;

  // stable per-browser id (works even if cookies are blocked)
  let uid = LS.get('nua:uid') || cookieGet('nua_uid') || uuid();
  LS.set('nua:uid', uid);
  cookieSet('nua_uid', uid);

  const votedKey = `voted:${slug}`;
  const fmt = (n) => Intl.NumberFormat().format(n || 0);
  const currentNum = () => {
    const s = (out.textContent || '0').replace(/[^\d]/g,'');
    const n = parseInt(s, 10);
    return Number.isFinite(n) ? n : 0;
  };

  // if already voted on this browser, reflect it immediately
  if (LS.get(votedKey) === '1') { btn.setAttribute('aria-pressed','true'); btn.disabled = true; }

  // Fetch count when visible (tries functions; falls back locally if 404)
  new IntersectionObserver((es, ob) => {
    if (!es.some(e => e.isIntersecting)) return;
    ob.disconnect();
    fetch(`/.netlify/functions/vote?slug=${encodeURIComponent(slug)}&uid=${encodeURIComponent(uid)}`, { credentials: 'same-origin' })
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(d => {
        out.textContent = fmt(d.count);
        if (d.alreadyVoted || LS.get(votedKey) === '1') { btn.setAttribute('aria-pressed','true'); btn.disabled = true; }
      })
      .catch(() => {
        // dev/offline: show local dev count if any
        const local = parseInt(LS.get(`dev:count:${slug}`) || '0', 10);
        out.textContent = fmt(local);
      });
  }).observe(el);

  async function upvote() {
    if (btn.disabled) return;

    // optimistic bump so you see it immediately
    out.textContent = fmt(currentNum() + 1);
    btn.disabled = true; btn.setAttribute('aria-pressed','true');

    try {
      const r = await fetch('/.netlify/functions/vote', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug, uid })
      });
      if (!r.ok) throw r;
      const d = await r.json();
      out.textContent = fmt(d.count); // reconcile with server count
      LS.set(votedKey, '1');
    } catch {
      // dev/offline fallback so it still feels correct on hugo server
      const key = `dev:count:${slug}`;
      const n = (parseInt(LS.get(key) || '0', 10) + 1);
      LS.set(key, String(n));
      LS.set(votedKey, '1');
    }
  }

  btn.addEventListener('click', upvote, { passive: true });
})();
</script>


